<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ„Ÿæ¸¬å™¨ç›£æ§ç³»çµ± - PostgreSQLç‰ˆ</title>
    <style>
        /* åŸºæœ¬æ¨£å¼è¨­å®š */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f0f0;
        }
        
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        /* æŒ‰éˆ•æ¨£å¼ */
        .controls {
            text-align: center;
            margin-bottom: 30px;
        }
        
        button {
            padding: 12px 24px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        
        .btn-start {
            background-color: #4CAF50;
            color: white;
        }
        
        .btn-stop {
            background-color: #f44336;
            color: white;
        }
        
        .btn-clear {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-health {
            background-color: #2196F3;
            color: white;
        }
        
        button:hover:not(:disabled) {
            opacity: 0.8;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* ç‹€æ…‹é¡¯ç¤º */
        .status {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
            font-size: 16px;
        }
        
        .status.connected {
            background-color: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }
        
        .status.disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }
        
        .status.connecting {
            background-color: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
        }
        
        /* æ„Ÿæ¸¬å™¨ç¶²æ ¼ä½ˆå±€ */
        .sensors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* æ„Ÿæ¸¬å™¨æ¡†æ¨£å¼ */
        .sensor-box {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .sensor-box.ph {
            border-color: #007bff;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .sensor-box.orp {
            border-color: #28a745;
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        }
        
        .sensor-box.ntu {
            border-color: #ffc107;
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        }
        
        .sensor-box:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        
        .sensor-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .sensor-box.ph .sensor-title {
            color: #0056b3;
        }
        
        .sensor-box.orp .sensor-title {
            color: #1e7e34;
        }

        .sensor-box.ntu .sensor-title {
            color: #856404;
        }
        
        .sensor-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .sensor-box.ph .sensor-value {
            color: #004085;
        }
        
        .sensor-box.orp .sensor-value {
            color: #155724;
        }

        .sensor-box.ntu .sensor-value {
            color: #856404;
        }
        
        .sensor-unit {
            font-size: 16px;
            color: #6c757d;
            font-weight: normal;
            margin-top: 5px;
        }
        
        .sensor-timestamp {
            font-size: 12px;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .sensor-status {
            font-size: 14px;
            margin-top: 10px;
            padding: 5px 10px;
            border-radius: 20px;
            display: inline-block;
        }
        
        .sensor-status.active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .sensor-status.inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* ç­‰å¾…æ•¸æ“šçš„ç‹€æ…‹ */
        .waiting {
            color: #6c757d;
            font-style: italic;
        }
        
        /* éŒ¯èª¤é¡¯ç¤º */
        .error {
            background-color: #ffebee;
            color: #c62828;
            border: 2px solid #ef9a9a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* æˆåŠŸé¡¯ç¤º */
        .success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 2px solid #a5d6a7;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
        }
        
        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .sensors-grid {
                grid-template-columns: 1fr;
            }
            
            .sensor-value {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ æ„Ÿæ¸¬å™¨å³æ™‚ç›£æ§ç³»çµ± (PostgreSQLç‰ˆ)</h1>
        
        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="controls">
            <button id="startBtn" class="btn-start">ğŸš€ é–‹å§‹ç›£æ§</button>
            <button id="stopBtn" class="btn-stop" disabled>â¹ï¸ åœæ­¢ç›£æ§</button>
            <button id="clearBtn" class="btn-clear">ğŸ§¹ æ¸…é™¤é¡¯ç¤º</button>
            <button id="healthBtn" class="btn-health">ğŸ’Š æª¢æŸ¥è³‡æ–™åº«</button>
        </div>
        
        <!-- é€£æ¥ç‹€æ…‹ -->
        <div id="status" class="status disconnected">ğŸ”´ æœªé€£æ¥</div>
        
        <!-- æ„Ÿæ¸¬å™¨é¡¯ç¤ºå€åŸŸ -->
        <div class="sensors-grid">
            <!-- pHå€¼é¡¯ç¤ºæ¡† -->
            <div class="sensor-box ph" id="phBox">
                <div class="sensor-title">ğŸ“Š pHå€¼</div>
                <div class="sensor-value waiting" id="phValue">ç­‰å¾…æ•¸æ“š...</div>
                <div class="sensor-unit">pH</div>
                <div class="sensor-timestamp" id="phTimestamp"></div>
                <div class="sensor-status inactive" id="phStatus">æœªæ¿€æ´»</div>
            </div>
            
            <!-- ORPå€¼é¡¯ç¤ºæ¡† -->
            <div class="sensor-box orp" id="orpBox">
                <div class="sensor-title">âš¡ ORPå€¼</div>
                <div class="sensor-value waiting" id="orpValue">ç­‰å¾…æ•¸æ“š...</div>
                <div class="sensor-unit">mV</div>
                <div class="sensor-timestamp" id="orpTimestamp"></div>
                <div class="sensor-status inactive" id="orpStatus">æœªæ¿€æ´»</div>
            </div>
            <!-- æ¿åº¦å€¼é¡¯ç¤ºæ¡† -->
            <div class="sensor-box ntu" id="ntuBox">
                <div class="sensor-title">ğŸŒŠ æ¿åº¦å€¼</div>
                <div class="sensor-value waiting" id="ntuValue">ç­‰å¾…æ•¸æ“š...</div>
                <div class="sensor-unit">NTU</div>
                <div class="sensor-timestamp" id="ntuTimestamp"></div>
                <div class="sensor-status inactive" id="ntuStatus">æœªæ¿€æ´»</div>
            </div>
        </div>
        
        <!-- éŒ¯èª¤/æˆåŠŸé¡¯ç¤ºå€åŸŸ -->
        <div id="messageDisplay" style="display: none;"></div>
    </div>

    <script>
        // ===================
        // JavaScript é–‹å§‹
        // ===================

        const API_BASE_URL = 'https://cems-arduino.onrender.com';
        //const API_BASE_URL = 'http://127.0.0.1:8000';  // æ›¿æ›ç‚ºä½ çš„å¾Œç«¯æœå‹™å™¨åœ°å€
        
        // 1. ç²å–HTMLå…ƒç´ 
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const healthBtn = document.getElementById('healthBtn');
        const statusDiv = document.getElementById('status');
        const messageDisplay = document.getElementById('messageDisplay');
        
        // æ„Ÿæ¸¬å™¨å…ƒç´ 
        const phValue = document.getElementById('phValue');
        const phTimestamp = document.getElementById('phTimestamp');
        const phStatus = document.getElementById('phStatus');
        
        const orpValue = document.getElementById('orpValue');
        const orpTimestamp = document.getElementById('orpTimestamp');
        const orpStatus = document.getElementById('orpStatus');

        const ntuValue = document.getElementById('ntuValue');
        const ntuTimestamp = document.getElementById('ntuTimestamp');
        const ntuStatus = document.getElementById('ntuStatus');
        
        // 2. å…¨å±€è®Šæ•¸
        let eventSource = null;  // ç”¨ä¾†å­˜å„²SSEé€£æ¥
        
        // 3. æ›´æ–°å–®å€‹æ„Ÿæ¸¬å™¨é¡¯ç¤ºçš„å‡½æ•¸
        function updateSensorDisplay(type, value, timestamp, unit = '') {
            const currentTime = new Date().toLocaleString('zh-TW', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            
            let valueElement, timestampElement, statusElement;
            
            switch(type) {
                case 'ph':
                    valueElement = phValue;
                    timestampElement = phTimestamp;
                    statusElement = phStatus;
                    break;
                case 'orp':
                    valueElement = orpValue;
                    timestampElement = orpTimestamp;
                    statusElement = orpStatus;
                    break;
                case 'ntu':
                    valueElement = ntuValue;
                    timestampElement = ntuTimestamp;
                    statusElement = ntuStatus;
                    break;
                default:
                    return;
            }
            
            // æ›´æ–°æ•¸å€¼
            if (value !== null && value !== undefined) {
                valueElement.textContent = value + (unit ? ` ${unit}` : '');
                valueElement.className = 'sensor-value';
                
                // æ›´æ–°æ™‚é–“æˆ³
                timestampElement.textContent = `æ›´æ–°æ™‚é–“: ${currentTime}`;
                if (timestamp) {
                    // æ ¼å¼åŒ–è³‡æ–™åº«æ™‚é–“æˆ³
                    const dbTime = new Date(timestamp).toLocaleString('zh-TW', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });
                    timestampElement.textContent += ` | æ•¸æ“šæ™‚é–“: ${dbTime}`;
                }
                
                // æ›´æ–°ç‹€æ…‹
                statusElement.textContent = 'é‹è¡Œä¸­';
                statusElement.className = 'sensor-status active';
            }
        }
        
        // 4. è™•ç†æ¥æ”¶åˆ°çš„æ•¸æ“š
        function handleData(data) {
            // éš±è—è¨Šæ¯é¡¯ç¤º
            messageDisplay.style.display = 'none';
            
            // æª¢æŸ¥æ•¸æ“šæ ¼å¼
            if (data.latest_data) {
                const latest = data.latest_data;
                
                // æ›´æ–°å„å€‹æ„Ÿæ¸¬å™¨
                if (latest.ph_value !== undefined && latest.ph_value !== null) {
                    updateSensorDisplay('ph', latest.ph_value, latest.timestamp);
                }
                
                if (latest.orp_value !== undefined && latest.orp_value !== null) {
                    updateSensorDisplay('orp', latest.orp_value, latest.timestamp);
                }
                if (latest.ntu_value !== undefined && latest.ntu_value !== null) {
                    updateSensorDisplay('ntu', latest.ntu_value, latest.timestamp);
                }
            }
        }
        
        // 5. é¡¯ç¤ºè¨Šæ¯
        function showMessage(message, type = 'error') {
            const className = type === 'error' ? 'error' : 'success';
            const icon = type === 'error' ? 'âŒ' : 'âœ…';
            messageDisplay.innerHTML = `<div class="${className}">${icon} ${message}</div>`;
            messageDisplay.style.display = 'block';
        }
        
        // 6. æª¢æŸ¥è³‡æ–™åº«å¥åº·ç‹€æ…‹
        async function checkDatabaseHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/v1/data/health`);
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`è³‡æ–™åº«ç‹€æ…‹: ${data.status} - ${data.database}`, 'success');
                } else {
                    const errorData = await response.json();
                    showMessage(`è³‡æ–™åº«æª¢æŸ¥å¤±æ•—: ${errorData.detail}`, 'error');
                }
            } catch (error) {
                showMessage(`ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯æœå‹™: ${error.message}`, 'error');
            }
        }
        
        // 7. é–‹å§‹ç›£æ§çš„å‡½æ•¸
        function startMonitoring() {
            // å¦‚æœå·²ç¶“æœ‰é€£æ¥ï¼Œå…ˆé—œé–‰å®ƒ
            if (eventSource) {
                eventSource.close();
            }
            
            // é¡¯ç¤ºé€£æ¥ä¸­ç‹€æ…‹
            statusDiv.textContent = 'ğŸŸ¡ é€£æ¥ä¸­...';
            statusDiv.className = 'status connecting';
            
            // âš ï¸ é‡è¦ï¼šé€™è£¡è¦æ”¹æˆä½ çš„å¾Œç«¯æœå‹™å™¨åœ°å€
            eventSource = new EventSource(`${API_BASE_URL}/api/v1/data/replace`);
            
            // é€£æ¥æˆåŠŸæ™‚çš„è™•ç†
            eventSource.onopen = function(event) {
                console.log('SSEé€£æ¥å·²å»ºç«‹');
                statusDiv.textContent = 'ğŸŸ¢ å·²é€£æ¥è³‡æ–™åº«';
                statusDiv.className = 'status connected';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                messageDisplay.style.display = 'none';
            };
            
            // æ¥æ”¶åˆ°æ•¸æ“šæ™‚çš„è™•ç†
            eventSource.onmessage = function(event) {
                console.log('æ”¶åˆ°æ•¸æ“š:', event.data);
                
                try {
                    // è§£æJSONæ•¸æ“š
                    const data = JSON.parse(event.data);
                    
                    // æª¢æŸ¥æ˜¯å¦æœ‰éŒ¯èª¤
                    if (data.error) {
                        showMessage(data.error, 'error');
                        return;
                    }
                    
                    // è™•ç†æ•¸æ“š
                    handleData(data);
                    
                } catch (error) {
                    console.error('è§£ææ•¸æ“šå¤±æ•—:', error);
                    showMessage(`æ•¸æ“šè§£æéŒ¯èª¤: ${error.message}`, 'error');
                }
            };
            
            // é€£æ¥éŒ¯èª¤æ™‚çš„è™•ç†
            eventSource.onerror = function(event) {
                console.error('SSEé€£æ¥éŒ¯èª¤:', event);
                statusDiv.textContent = 'ğŸ”´ é€£æ¥éŒ¯èª¤';
                statusDiv.className = 'status disconnected';
                startBtn.disabled = false;
                stopBtn.disabled = true;
                
                // è¨­ç½®æ‰€æœ‰æ„Ÿæ¸¬å™¨ç‚ºæœªæ¿€æ´»ç‹€æ…‹
                [phStatus, orpStatus,ntuStatus].forEach(status => {
                    status.textContent = 'é€£æ¥ä¸­æ–·';
                    status.className = 'sensor-status inactive';
                });
                
                showMessage('é€£æ¥ä¸­æ–·ï¼Œå°‡åœ¨5ç§’å¾Œå˜—è©¦é‡æ–°é€£æ¥...', 'error');
                
                // è‡ªå‹•é‡é€£ï¼ˆå¯é¸ï¼‰
                setTimeout(() => {
                    if (eventSource && eventSource.readyState === EventSource.CLOSED) {
                        console.log('å˜—è©¦é‡æ–°é€£æ¥...');
                        startMonitoring();
                    }
                }, 5000); // 5ç§’å¾Œé‡é€£
            };
        }
        
        // 8. åœæ­¢ç›£æ§çš„å‡½æ•¸
        function stopMonitoring() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            
            statusDiv.textContent = 'ğŸ”´ å·²æ–·é–‹é€£æ¥';
            statusDiv.className = 'status disconnected';
            startBtn.disabled = false;
            stopBtn.disabled = true;
            
            // è¨­ç½®æ‰€æœ‰æ„Ÿæ¸¬å™¨ç‚ºæœªæ¿€æ´»ç‹€æ…‹
            [phStatus, orpStatus,ntuStatus].forEach(status => {
                status.textContent = 'æœªæ¿€æ´»';
                status.className = 'sensor-status inactive';
            });
            
            messageDisplay.style.display = 'none';
        }
        
        // 9. æ¸…é™¤é¡¯ç¤ºçš„å‡½æ•¸
        function clearDisplay() {
            // é‡ç½®æ‰€æœ‰æ„Ÿæ¸¬å™¨é¡¯ç¤º
            [phValue, orpValue, ntuValue].forEach(element => {
                element.textContent = 'ç­‰å¾…æ•¸æ“š...';
                element.className = 'sensor-value waiting';
            });
            
            [phTimestamp, orpTimestamp, ntuTimestamp].forEach(element => {
                element.textContent = '';
            });
            
            [phStatus, orpStatus,ntuStatus].forEach(status => {
                status.textContent = 'æœªæ¿€æ´»';
                status.className = 'sensor-status inactive';
            });
            
            // éš±è—è¨Šæ¯é¡¯ç¤º
            messageDisplay.style.display = 'none';
        }
        
        // 10. ç¶å®šæŒ‰éˆ•äº‹ä»¶
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearDisplay);
        healthBtn.addEventListener('click', checkDatabaseHealth);
        
        // 11. é é¢é—œé–‰æ™‚æ¸…ç†è³‡æº
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
        
        // ===================
        // JavaScript çµæŸ
        // ===================
    </script>
</body>
</html>